(function(d){var k={init:function(a){a=d.extend({insert_in_form:1,input_name:"changed_state",exclude:[],debug_mode:0,ignore:null,if_changed:function(){return!0},save_state_history:1,state_history_length:10,controlling_attr:"name",onAddField:null,onChange:null},a);this.state_form("init_state",a);return this},init_state:function(a){this.each(function(){var b=d(this);b.submit(b.state_form("on_submit",a));b.data({settings:a});var c=d(":input",b).not('[type="button"],[type="submit"]');a.ignore&&(c=c.not(a.ignore));
c.each(function(){var c=d(this);b.state_form("add_field",c,a)})})},add_field:function(a,b){var c=d(a);if((b=b||this.state_form("get_settings"))&&!c.data("state")){var e={state:{element_name:null,first_val:null,raw_text_first:null,curent_val:null,raw_text_last:null,selected:!1}};c.state_form("set_value",e,b);c.state_form("set_name",e,b);c.change(c.state_form("call_change"));c.on("state_form.change",c.state_form("change_state"));if(b.onChange)c.on("state_form.change",b.onChange.bind(c));c.data(e);if(b.onAddField)b.onAddField(c)}},
remove_field:function(a){a=d(a);a.removeData("state");a.off("state_form.change");var b=d._data(a[0],"events"),c=a.state_form("call_change").toString();if(b.change)for(var e in b.change)if(!isNaN(e)&&b.change[e].handler.toString()===c){delete b.change[e];b.change.length--;break}a.removeAttr("data-state-is_changed")},set_name:function(a,b){void 0!==this.attr(b.controlling_attr)?(b.debug_mode&&1<d("["+b.controlling_attr+'="'+this.attr(b.controlling_attr)+'"]').size()&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0430\u0442\u0440\u0438\u0431\u0443\u0442 "+
b.controlling_attr+" \u043d\u0430\u0439\u0434\u0435\u043d \u0443 \u0431\u043e\u043b\u0435\u0435 \u0447\u0435\u043c \u043e\u0434\u043d\u043e\u0433\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430"),window.console.debug(this)),a.state.element_name=this.attr(b.controlling_attr)):void 0!==this.attr("id")?a.state.element_name=this.attr("id"):b.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0443 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u043d\u0435\u0442 \u0438\u043c\u0435\u043d\u0438! (WARNING: element has no name!)"),
window.console.debug(this))},set_value:function(a,b){var c=this[0];switch(c.tagName){case "INPUT":"checkbox"==c.type||"radio"==c.type?void 0!==this.attr("value")?"radio"!=c.type?this.is(":checked")&&(a.state.first_val=this.val()):(this.is(":checked")&&(a.state.selected=!0),a.state.first_val=this.val()):a.state.first_val=this.is(":checked"):void 0===this.attr("value")?b.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0443 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u043d\u0435\u0442 \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u0430 value! (WARNING: element has no attr value!)"),
window.console.debug(c)):a.state.first_val=this.val();break;case "TEXTAREA":a.state.first_val=this.val();break;case "SELECT":a.state.first_val=this.val(),a.state.raw_text_first=this.find("option:selected").text()}},on_submit:function(a){return function(){var b=d(this);if(b.state_form("is_changed")){if(a.insert_in_form){var c=d('<input type="hidden" name="'+a.input_name+'">');b.append(c);c.val(JSON.stringify(b.state_form("get_changes")))}else d('input[name="changed_state"]',b).remove();return a.if_changed.call(b)}return!0}},
is_changed:function(){return this.state_form("get_changes").length?!0:!1},get_changes:function(){var a=[],b=this.data().settings;b&&(d("[data-state-is_changed]",this).each(function(){var c=d(this).data().state;-1===d.inArray(c.element_name,b.exclude)&&a.push(c)}),d('input[type="hidden"]',this).not("[data-state-is_changed]").each(function(){var c=d(this),e=c.data();"object"===typeof e&&e.hasOwnProperty("state")&&(e=e.state,-1===d.inArray(e.element_name,b.exclude)&&e.first_val!=c.val()&&a.push(e))}));
return a},call_change:function(){return function(){d(this).trigger("state_form.change")}},change_state:function(){return function(){var a=d(this),b=a.data(),c=a.val();"checkbox"==this.type||"radio"==this.type?a.is(":checked")&&void 0!==a.attr("value")?b.state.curent_val=c:b.state.curent_val=c=a.is(":checked"):(b.state.curent_val=c,"SELECT"==this.tagName&&(b.state.raw_text_last=a.find("option:selected").text()));null===c&&(c="");null===b.state.first_val&&(b.state.first_val="");c!=b.state.first_val?
a.attr("data-state-is_changed","1"):"radio"==this.type?a.is(":checked")&&!b.state.selected?a.attr("data-state-is_changed","1"):(a=d(this),b=a.parents("form").state_form("get_settings"),c=a.parents("form"),d("["+b.controlling_attr+'="'+a.attr(b.controlling_attr)+'"]',c).removeAttr("data-state-is_changed")):a.removeAttr("data-state-is_changed")}},save_state:function(a){var b=!1,c=this.state_form("get_settings");"FORM"!=this[0].tagName&&(b=this);c.save_state_history&&this.state_form("create_snapshot",
a);b?(a=b.data(),"object"===typeof a&&a.hasOwnProperty("state")&&(a.state.first_val=b.val(),b.state_form("set_value",a,c),b.removeAttr("data-state-is_changed"))):d(":input",this).not('[type="button"],[type="submit"]').each(function(){var a=d(this),b=a.data();"object"===typeof b&&b.hasOwnProperty("state")&&(b.state.first_val=a.val(),a.state_form("set_value",b,c),a.removeAttr("data-state-is_changed"))});return this},get_settings:function(){var a={};return a="FORM"!=this[0].tagName?d(this[0].form).data().settings:
this.data().settings},create_snapshot:function(a){var b={},c=[];"undefined"!==typeof window.localStorage.form_state_snapshot&&(c=JSON.parse(window.localStorage.form_state_snapshot));a=a||c.length;var e=[],f=null,g=0,g=this.state_form("get_settings"),f="FORM"==this[0].tagName?d(":input",this).not('[type="button"],[type="submit"]'):this,g=g.state_history_length;d(f).not('[type="button"],[type="submit"]').each(function(){var a=d(this).data();"object"===typeof a&&a.hasOwnProperty("state")&&e.push(a.state)});
b[a]=e;var f=!1,h;for(h in c)if(c[h].hasOwnProperty(a)){c[h]=b;f=!0;break}f||(c.length>=g&&c.shift(),c.push(b));window.localStorage.form_state_snapshot=JSON.stringify(c);"FORM"==this[0].tagName&&(window.localStorage.form_state_last_form_snapshot=JSON.stringify(b))},restore_state:function(a){var b=null;a?b=this.state_form("get_history",a):"FORM"==this[0].tagName?"undefined"!==typeof window.localStorage.form_state_snapshot&&(b=JSON.parse(window.localStorage.form_state_last_form_snapshot)):b=this.state_form("find_state");
if(b){a=this.state_form("get_settings");for(var c in b)for(var e in b[c]){var f=b[c][e],g=f.element_name,h=null;d("["+a.controlling_attr+'="'+g+'"]').size()?h=d("["+a.controlling_attr+'="'+g+'"]'):d("#"+g).size()?h=d("#"+g):a.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u043f\u043e\u043b\u0435 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e \u0432 \u0444\u043e\u0440\u043c\u0435! (WARNING: field not found in the form!)"),window.console.debug(this));g=
h.data().state;g.curent_val=f.curent_val;g.first_val=f.curent_val;g.raw_text_first=f.raw_text_first;g.raw_text_last=f.raw_text_last;g.selected=f.selected;"radio"===h[0].type?h.each(function(){var a=d(this),b=a.val();void 0!==this.value&&null!==f.curent_val&&b==f.curent_val&&(f.selected&&a.attr("checked","cheked").change(),a.data().state.first_val=f.curent_val,a.data().state.curent_val=f.curent_val)}):"checkbox"===h[0].type?!1===f.curent_val?h.removeAttr("checked").change():h.attr("checked","cheked").change():
null!==f.curent_val&&h.val(f.curent_val).change()}}return this},get_history:function(a){a=a||!1;var b=[],c={};"undefined"!==typeof window.localStorage.form_state_snapshot&&(b=JSON.parse(window.localStorage.form_state_snapshot));if(a)if("state_form_all"==a)c=b;else for(var d in b){if(b[d].hasOwnProperty(a)){c=b[d];break}}else c=b.pop();return c},find_state:function(){var a=[],b={},c=this.parents("form").state_form("get_settings");this.not('[type="button"],[type="submit"]').each(function(){void 0!==
d(this).attr(c.controlling_attr)?a.push(this.attr(c.controlling_attr)):void 0!==this.id&&a.push(this.id)});var a=a.join(","),e=this.state_form("get_history","state_form_all");e.reverse();var f;a:for(f in e)for(var g in e[f]){var h=[],k;for(k in e[f][g])h.push(e[f][g][k].element_name);h=h.join(",");if(h==a){b=e[f];break a}}return b},is_jQuery:function(a){return null!=a&&a.constructor===jQuery}};d.fn.state_form=function(a){if(k[a])return k[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"!==
typeof a&&a)d.error("\u041c\u0435\u0442\u043e\u0434 \u0441 \u0438\u043c\u0435\u043d\u0435\u043c "+a+" \u043d\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043b\u044f jQuery");else return k.init.apply(this,arguments)}})(jQuery);