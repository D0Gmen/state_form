(function(d){var k={init:function(a){a=d.extend({insert_in_form:1,input_name:"changed_state",exclude:[],debug_mode:0,if_changed:function(){return!0},save_state_history:1,state_history_length:10},a);this.state_form("init_state",a);return this},init_state:function(a){this.each(function(){var b=d(this);b.submit(b.state_form("on_submit",a));b.data({settings:a});d(":input",b).not('[type="button"],[type="submit"]').each(function(){var b=d(this),g={state:{element_name:null,first_val:null,raw_text_first:null,
curent_val:null,raw_text_last:null,selected:!1}};b.state_form("set_value",g,a);b.state_form("set_name",g,a);b.change(b.state_form("change_state"));b.data(g)})})},set_name:function(a,b){void 0!==this.attr("name")?a.state.element_name=this.attr("name"):void 0!==this.attr("id")?a.state.element_name=this.attr("id"):b.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0443 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u043d\u0435\u0442 \u0438\u043c\u0435\u043d\u0438! (WARNING: element has no name!)"),
window.console.debug(this))},set_value:function(a,b){var c=this[0];switch(c.tagName){case "INPUT":"checkbox"==c.type||"radio"==c.type?void 0!==this.attr("value")?"radio"!=c.type?this.is(":checked")&&(a.state.first_val=this.val()):(this.is(":checked")&&(a.state.selected=!0),a.state.first_val=this.val()):a.state.first_val=this.is(":checked"):void 0===this.attr("value")?b.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u0443 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u043d\u0435\u0442 \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u0430 value! (WARNING: element has no attr value!)"),
window.console.debug(c)):a.state.first_val=this.val();break;case "TEXTAREA":a.state.first_val=this.val();break;case "SELECT":a.state.first_val=this.val(),a.state.raw_text_first=this.find("option:selected").text()}},on_submit:function(a){return function(){var b=d(this);if(b.state_form("is_changed")){if(a.insert_in_form){var c=d('<input type="hidden" name="'+a.input_name+'">');b.append(c);c.val(JSON.stringify(b.state_form("get_changes")))}else d('input[name="changed_state"]',b).remove();return a.if_changed.call(b)}return!0}},
is_changed:function(){return this.state_form("get_changes").length?!0:!1},get_changes:function(){var a=[],b=this.data().settings;d("[data-state-is_changed]",this).each(function(){var c=d(this).data().state;-1===d.inArray(c.element_name,b.exclude)&&a.push(c)});d('input[type="hidden"]',this).not("[data-state-is_changed]").each(function(){var c=d(this),g=c.data();"object"===typeof g&&g.hasOwnProperty("state")&&(g=g.state,-1===d.inArray(g.element_name,b.exclude)&&g.first_val!=c.val()&&a.push(g))});return a},
change_state:function(){return function(){var a=d(this),b=a.data(),c=a.val();"checkbox"==this.type||"radio"==this.type?a.is(":checked")&&void 0!==a.attr("value")?b.state.curent_val=c:b.state.curent_val=c=a.is(":checked"):(b.state.curent_val=c,"SELECT"==this.tagName&&(b.state.raw_text_last=a.find("option:selected").text()));c!=b.state.first_val?a.attr("data-state-is_changed","1"):"radio"==this.type?a.is(":checked")&&!b.state.selected?a.attr("data-state-is_changed","1"):(a=a.parents("form"),d('[name="'+
this.name+'"]',a).removeAttr("data-state-is_changed")):a.removeAttr("data-state-is_changed")}},save_state:function(a){var b=!1,c=this.state_form("get_settings");"FORM"!=this[0].tagName&&(b=this);c.save_state_history&&this.state_form("create_snapshot",a);b?(a=b.data(),"object"===typeof a&&a.hasOwnProperty("state")&&(a.state.first_val=b.val(),b.state_form("set_value",a,c),b.removeAttr("data-state-is_changed"))):d(":input",this).not('[type="button"],[type="submit"]').each(function(){var a=d(this),b=
a.data();"object"===typeof b&&b.hasOwnProperty("state")&&(b.state.first_val=a.val(),a.state_form("set_value",b,c),a.removeAttr("data-state-is_changed"))});return this},get_settings:function(){var a={};return a="FORM"!=this[0].tagName?d(this[0].form).data().settings:this.data().settings},create_snapshot:function(a){var b={},c=[];"undefined"!==typeof window.localStorage.form_state_snapshot&&(c=JSON.parse(window.localStorage.form_state_snapshot));a=a||c.length;var g=[],e=null,f=0,f=this.state_form("get_settings"),
e="FORM"==this[0].tagName?d(":input",this).not('[type="button"],[type="submit"]'):this,f=f.state_history_length;d(e).not('[type="button"],[type="submit"]').each(function(){var a=d(this).data();"object"===typeof a&&a.hasOwnProperty("state")&&g.push(a.state)});b[a]=g;var e=!1,h;for(h in c)if(c[h].hasOwnProperty(a)){c[h]=b;e=!0;break}e||(c.length>=f&&c.shift(),c.push(b));window.localStorage.form_state_snapshot=JSON.stringify(c);"FORM"==this[0].tagName&&(window.localStorage.form_state_last_form_snapshot=
JSON.stringify(b))},restore_state:function(a){var b=null;a?b=this.state_form("get_history",a):"FORM"==this[0].tagName?"undefined"!==typeof window.localStorage.form_state_snapshot&&(b=JSON.parse(window.localStorage.form_state_last_form_snapshot)):b=this.state_form("find_state");if(b){a=this.state_form("get_settings");for(var c in b)for(var g in b[c]){var e=b[c][g],f=e.element_name,h=null;d('[name="'+f+'"]').size()?h=d('[name="'+f+'"]'):d("#"+f).size()?h=d("#"+f):a.debug_mode&&(window.console.warn("\u0412\u043d\u0438\u043c\u0430\u043d\u0438\u0435: \u043f\u043e\u043b\u0435 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e \u0432 \u0444\u043e\u0440\u043c\u0435! (WARNING: field not found in the form!)"),
window.console.debug(this));f=h.data().state;f.curent_val=e.curent_val;f.first_val=e.curent_val;f.raw_text_first=e.raw_text_first;f.raw_text_last=e.raw_text_last;f.selected=e.selected;"radio"===h[0].type?h.each(function(){var a=d(this),b=a.val();void 0!==this.value&&null!==e.curent_val&&b==e.curent_val&&(e.selected&&a.attr("checked","cheked").change(),a.data().state.first_val=e.curent_val,a.data().state.curent_val=e.curent_val)}):"checkbox"===h[0].type?!1===e.curent_val?h.removeAttr("checked").change():
h.attr("checked","cheked").change():null!==e.curent_val&&h.val(e.curent_val).change()}}return this},get_history:function(a){a=a||!1;var b=[],c={};"undefined"!==typeof window.localStorage.form_state_snapshot&&(b=JSON.parse(window.localStorage.form_state_snapshot));if(a)if("state_form_all"==a)c=b;else for(var d in b){if(b[d].hasOwnProperty(a)){c=b[d];break}}else c=b.pop();return c},find_state:function(){var a=[],b={};this.not('[type="button"],[type="submit"]').each(function(){void 0!==this.name?a.push(this.name):
void 0!==this.id&&a.push(this.id)});var a=a.join(","),c=this.state_form("get_history","state_form_all");c.reverse();var d;a:for(d in c)for(var e in c[d]){var f=[],h;for(h in c[d][e])f.push(c[d][e][h].element_name);f=f.join(",");if(f==a){b=c[d];break a}}return b},is_jQuery:function(a){return null!=a&&a.constructor===jQuery}};d.fn.state_form=function(a){if(k[a])return k[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"!==typeof a&&a)d.error("\u041c\u0435\u0442\u043e\u0434 \u0441 \u0438\u043c\u0435\u043d\u0435\u043c "+
a+" \u043d\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043b\u044f jQuery");else return k.init.apply(this,arguments)}})(jQuery);